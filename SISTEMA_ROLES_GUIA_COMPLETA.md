# üë• SISTEMA DE ROLES - GU√çA COMPLETA Y DETALLADA

## üéØ **¬øQU√â ES LO QUE HEMOS CREADO?**

Hemos implementado un **sistema completo de roles y permisos** para el MoodTracker. Esto significa que ahora podemos controlar qu√© usuarios pueden hacer qu√© cosas en la aplicaci√≥n.

---

## üèóÔ∏è **PARTE 1: LAS TABLAS DE LA BASE DE DATOS**

### **üìã Tabla `roles`**
```sql
CREATE TABLE roles (
    id BIGINT PRIMARY KEY,
    name VARCHAR UNIQUE,           -- Nombre del rol (ej: 'hr_admin')
    description VARCHAR,            -- Descripci√≥n del rol
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);
```

**¬øPara qu√© sirve?**
- Almacena los diferentes tipos de usuarios que pueden existir
- Como una "etiqueta" que define qu√© puede hacer cada persona

**Ejemplo de datos:**
```
id | name        | description
1  | super_admin | Acceso total al sistema
2  | hr_admin    | Panel RRHH (empresa/√°rea)
3  | manager     | Gesti√≥n de equipo/segmento
4  | employee    | Usuario est√°ndar (autogesti√≥n)
```

### **üìã Tabla `role_user` (Tabla Pivot)**
```sql
CREATE TABLE role_user (
    user_id BIGINT,               -- ID del usuario
    role_id BIGINT,               -- ID del rol
    company_id BIGINT,             -- ID de la empresa (opcional)
    PRIMARY KEY (user_id, role_id, company_id)
);
```

**¬øPara qu√© sirve?**
- Conecta usuarios con roles
- Un usuario puede tener varios roles
- Un rol puede tener varios usuarios
- Soporte para multiempresa (un usuario puede tener diferentes roles en diferentes empresas)

**Ejemplo de datos:**
```
user_id | role_id | company_id
1       | 2       | 1          -- Usuario 1 es hr_admin en empresa 1
1       | 3       | 2          -- Usuario 1 es manager en empresa 2
2       | 4       | 1          -- Usuario 2 es employee en empresa 1
```

---

## üß© **PARTE 2: LOS MODELOS DE LARAVEL**

### **üë§ Modelo `User.php` - L√≠nea por l√≠nea**

```php
// L√≠nea 50-53: Relaci√≥n con roles
public function roles()
{
    return $this->belongsToMany(\App\Models\Role::class)->withPivot('company_id');
}
```
**¬øQu√© hace?**
- Crea una relaci√≥n "muchos a muchos" entre usuarios y roles
- `belongsToMany` = un usuario puede tener varios roles
- `withPivot('company_id')` = incluye el ID de la empresa en la relaci√≥n
- **Resultado:** `$user->roles` te da todos los roles del usuario

```php
// L√≠nea 55-63: Verificar si un usuario tiene un rol espec√≠fico
public function hasRole(string $roleName, $companyId = null): bool
{
    $roles = $this->roles;
    if ($companyId !== null) {
        return $roles->where('pivot.company_id', $companyId)->contains('name', $roleName)
            || $roles->where('name', 'super_admin')->isNotEmpty();
    }
    return $roles->contains('name', $roleName) || $roles->contains('name', 'super_admin');
}
```
**¬øQu√© hace?**
- Verifica si un usuario tiene un rol espec√≠fico
- Si se especifica `$companyId`, busca el rol solo en esa empresa
- Si no se especifica, busca el rol en cualquier empresa
- **L√≥gica especial:** `super_admin` siempre tiene acceso a todo
- **Resultado:** `$user->hasRole('hr_admin')` devuelve `true` o `false`

```php
// L√≠nea 65-68: Verificar si es administrador
public function isAdmin(): bool
{
    return $this->hasRole('super_admin') || $this->hasRole('hr_admin');
}
```
**¬øQu√© hace?**
- M√©todo de conveniencia para verificar si es admin
- Un usuario es admin si tiene rol `super_admin` O `hr_admin`
- **Resultado:** `$user->isAdmin()` devuelve `true` o `false`

```php
// L√≠nea 70-73: Verificar si es manager
public function isManager(): bool
{
    return $this->hasRole('manager');
}
```
**¬øQu√© hace?**
- Verifica si el usuario es manager
- **Resultado:** `$user->isManager()` devuelve `true` o `false`

```php
// L√≠nea 75-78: Verificar si es empleado
public function isEmployee(): bool
{
    return $this->hasRole('employee');
}
```
**¬øQu√© hace?**
- Verifica si el usuario es empleado
- **Resultado:** `$user->isEmployee()` devuelve `true` o `false`

```php
// L√≠nea 80-88: Asignar un rol a un usuario
public function assignRole(string $roleName, $companyId = null): void
{
    $role = Role::where('name', $roleName)->first();
    if ($role) {
        $this->roles()->syncWithoutDetaching([
            $role->id => ['company_id' => $companyId]
        ]);
    }
}
```
**¬øQu√© hace?**
- Asigna un rol a un usuario
- Busca el rol por nombre
- `syncWithoutDetaching` = a√±ade el rol sin quitar los existentes
- **Resultado:** `$user->assignRole('manager', $companyId)` asigna el rol

### **üé≠ Modelo `Role.php` - L√≠nea por l√≠nea**

```php
// L√≠nea 10: Campos que se pueden llenar autom√°ticamente
protected $fillable = ['name', 'description'];
```
**¬øQu√© hace?**
- Define qu√© campos se pueden asignar masivamente
- **Resultado:** `Role::create(['name' => 'admin', 'description' => 'Administrador'])`

```php
// L√≠nea 12-15: Relaci√≥n inversa con usuarios
public function users(): BelongsToMany
{
    return $this->belongsToMany(User::class)->withPivot('company_id');
}
```
**¬øQu√© hace?**
- Crea la relaci√≥n inversa: un rol puede tener varios usuarios
- **Resultado:** `$role->users` te da todos los usuarios con ese rol

```php
// L√≠nea 17-20: Buscar rol por nombre
public static function findByName(string $name): ?self
{
    return static::where('name', $name)->first();
}
```
**¬øQu√© hace?**
- M√©todo de conveniencia para buscar roles por nombre
- **Resultado:** `Role::findByName('hr_admin')` devuelve el rol o `null`

```php
// L√≠nea 22-25: Verificar si el rol tiene usuarios
public function hasUsers(): bool
{
    return $this->users()->exists();
}
```
**¬øQu√© hace?**
- Verifica si el rol tiene usuarios asignados
- **Resultado:** `$role->hasUsers()` devuelve `true` o `false`

---

## üöÄ **PARTE 3: ¬øQU√â CONSEGUIMOS CON ESTO?**

### **üéØ En el Dashboard Admin:**

#### **1. Control de Acceso por Roles:**
```php
// En un controlador
public function dashboard()
{
    if (!auth()->user()->isAdmin()) {
        abort(403, 'No tienes permisos para acceder');
    }
    
    // Solo los admins ven esta p√°gina
    return view('admin.dashboard');
}
```

#### **2. Vistas Diferentes por Rol:**
```php
// En una vista Blade
@if(auth()->user()->isAdmin())
    <div class="admin-panel">
        <h2>Panel de Administraci√≥n</h2>
        <!-- Contenido solo para admins -->
    </div>
@elseif(auth()->user()->isManager())
    <div class="manager-panel">
        <h2>Panel de Manager</h2>
        <!-- Contenido solo para managers -->
    </div>
@else
    <div class="employee-panel">
        <h2>Tu Panel Personal</h2>
        <!-- Contenido para empleados -->
    </div>
@endif
```

#### **3. Men√∫s Din√°micos:**
```php
// En el layout principal
<nav>
    <a href="/dashboard">Inicio</a>
    
    @if(auth()->user()->isAdmin())
        <a href="/admin/users">Gestionar Usuarios</a>
        <a href="/admin/companies">Gestionar Empresas</a>
        <a href="/admin/reports">Reportes Avanzados</a>
    @endif
    
    @if(auth()->user()->hasRole('hr_admin'))
        <a href="/hr/employees">Empleados</a>
        <a href="/hr/mood-reports">Reportes de Mood</a>
    @endif
    
    @if(auth()->user()->isManager())
        <a href="/manager/team">Mi Equipo</a>
        <a href="/manager/team-mood">Mood del Equipo</a>
    @endif
</nav>
```

### **üéØ En la API:**

#### **1. Endpoints Protegidos:**
```php
// En routes/api.php
Route::middleware(['auth', 'role:hr_admin'])->group(function () {
    Route::get('/hr/employees', [HrController::class, 'employees']);
    Route::get('/hr/mood-data', [HrController::class, 'moodData']);
});

Route::middleware(['auth', 'role:manager'])->group(function () {
    Route::get('/manager/team', [ManagerController::class, 'team']);
    Route::get('/manager/team-mood', [ManagerController::class, 'teamMood']);
});
```

#### **2. Datos Filtrados por Rol:**
```php
// En un controlador
public function getMoodData()
{
    $user = auth()->user();
    
    if ($user->isAdmin()) {
        // Los admins ven todo
        return MoodEntry::with('user', 'answers')->get();
    } elseif ($user->hasRole('hr_admin')) {
        // HR ve datos de su empresa
        return MoodEntry::whereHas('user', function($q) {
            $q->where('company_id', auth()->user()->company_id);
        })->get();
    } elseif ($user->isManager()) {
        // Managers ven su equipo
        return MoodEntry::whereHas('user', function($q) {
            $q->where('department_id', auth()->user()->department_id);
        })->get();
    } else {
        // Empleados ven solo sus datos
        return auth()->user()->moodEntries;
    }
}
```

---

## üé≠ **PARTE 4: EJEMPLOS PR√ÅCTICOS DE USO**

### **üìä Escenario 1: Dashboard de HR**
```php
// Solo usuarios con rol 'hr_admin' pueden ver:
- Lista de todos los empleados de la empresa
- Reportes de mood por departamento
- Estad√≠sticas de bienestar
- Gesti√≥n de usuarios y roles
```

### **üë• Escenario 2: Panel de Manager**
```php
// Solo usuarios con rol 'manager' pueden ver:
- Su equipo directo
- Mood de su equipo
- Reportes de su departamento
- No pueden ver datos de otros departamentos
```

### **üë§ Escenario 3: Panel de Empleado**
```php
// Solo usuarios con rol 'employee' pueden ver:
- Sus propios datos de mood
- Su historial personal
- No pueden ver datos de otros
```

### **üîê Escenario 4: Super Admin**
```php
// Solo usuarios con rol 'super_admin' pueden:
- Acceder a TODO
- Gestionar todas las empresas
- Ver todos los datos
- Asignar y quitar roles
```

---

## üõ°Ô∏è **PARTE 5: SEGURIDAD Y PROTECCI√ìN**

### **üîí Middleware de Roles:**
```php
// Crear middleware: php artisan make:middleware CheckRole

class CheckRole
{
    public function handle($request, Closure $next, $role)
    {
        if (!auth()->user()->hasRole($role)) {
            abort(403, 'No tienes permisos');
        }
        return $next($request);
    }
}
```

### **üéØ Uso del Middleware:**
```php
// En routes/web.php
Route::middleware(['auth', 'role:hr_admin'])->group(function () {
    Route::get('/hr/dashboard', [HrController::class, 'dashboard']);
    Route::get('/hr/employees', [HrController::class, 'employees']);
});
```

---

## üìà **PARTE 6: BENEFICIOS DEL SISTEMA**

### **‚úÖ Para los Desarrolladores:**
- **C√≥digo limpio:** F√°cil verificar permisos con `$user->isAdmin()`
- **Seguridad:** Control granular de acceso
- **Flexibilidad:** F√°cil a√±adir nuevos roles
- **Mantenibilidad:** L√≥gica centralizada en los modelos

### **‚úÖ Para los Usuarios:**
- **Experiencia personalizada:** Cada usuario ve lo que necesita
- **Seguridad:** No pueden acceder a datos que no les corresponden
- **Claridad:** Roles bien definidos y comprensibles

### **‚úÖ Para el Negocio:**
- **Escalabilidad:** F√°cil a√±adir nuevas empresas y roles
- **Compliance:** Control de acceso para auditor√≠as
- **Flexibilidad:** Diferentes niveles de acceso seg√∫n necesidades

---

## üéØ **RESUMEN: ¬øQU√â HEMOS LOGRADO?**

1. **‚úÖ Sistema de roles completo** - 4 roles implementados
2. **‚úÖ Relaciones funcionando** - Usuarios conectados con roles
3. **‚úÖ Helpers √∫tiles** - M√©todos f√°ciles para verificar permisos
4. **‚úÖ Soporte multiempresa** - Roles espec√≠ficos por empresa
5. **‚úÖ Seguridad** - Control granular de acceso
6. **‚úÖ Flexibilidad** - F√°cil a√±adir nuevos roles y permisos

**¬°Ahora tienes la base perfecta para crear un dashboard admin completamente funcional y seguro!** üöÄ
